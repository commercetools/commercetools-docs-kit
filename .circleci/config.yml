version: 2.1

aliases:
  - &working_directory ~/commercetools-docs-kit

  - &restore_yarn_cache
    restore_cache:
      name: 'Restoring yarn cache'
      keys:
        - v1-yarn-cache-{{ .Branch }}-{{ checksum "yarn.lock" }}
        - v1-yarn-cache-{{ .Branch }}
        - v1-yarn-cache

  - &save_yarn_cache
    save_cache:
      name: 'Saving yarn cache'
      key: v1-yarn-cache-{{ .Branch }}-{{ checksum "yarn.lock" }}
      paths:
        - ~/.cache/yarn

  - &run_yarn
    run: yarn --frozen-lockfile

executors:
  node_10:
    working_directory: *working_directory
    docker:
      - image: circleci/node:10.17
  cypress:
    working_directory: *working_directory
    docker:
      - image: 'cypress/base:10.16.0'
        environment:
          TERM: xterm

commands:
  setup_dependencies:
    description: Installing dependencies
    steps:
      - checkout
      - *restore_yarn_cache
      - *run_yarn
  lint_and_test:
    description: Running linters and tests
    steps:
      - run:
          name: Running linters and tests
          command: yarn run jest --projects jest.{eslint,stylelint,test}.config.js --maxWorkers=3 --reporters jest-silent-reporter
  build_websites:
    description: Building websites for production
    steps:
      - run: yarn build
  save_websites_bundle:
    steps:
      - persist_to_workspace:
          root: *working_directory
          paths:
            - public/
  restore_websites_bundle:
    steps:
      - attach_workspace:
          at: *working_directory
  vrt_tests:
    description: Running Visual Regression Tests
    steps:
      - run:
          name: Updating (apt-get update)
          working_directory: *working_directory
          command: sudo apt-get update -y
      - run:
          name: Upgrading (apt-get upgrade)
          working_directory: *working_directory
          command: sudo apt-get upgrade -y
      - run:
          name: Installing Chrome headless dependencies
          working_directory: *working_directory
          command: |
            sudo apt-get install -yq gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 \
            libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 \
            libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 \
            libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 \
            ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget --fix-missing
      - run:
          name: Running Percy snapshots for docs-smoke-test
          command: PERCY_TOKEN="$PERCY_TOKEN_SMOKE_TESTS" yarn run percy snapshot public

jobs:
  build_lint_and_test:
    executor: node_10
    steps:
      - setup_dependencies
      - *save_yarn_cache
      - lint_and_test
      - build_websites
      - save_websites_bundle
  vrt_test:
    executor: node_10
    steps:
      - setup_dependencies
      - restore_websites_bundle
      - vrt_tests
  e2e_test:
    executor: cypress
    parameters:
      record:
        type: boolean
        default: false
      parallel:
        type: boolean
        default: false
      parallelism:
        type: integer
        default: 1
      start:
        type: string
        default: ''
      build:
        type: string
        default: ''
      wait-on:
        type: string
        default: ''
      run-command:
        type: string
        default: ''
      spec:
        type: string
        default: ''
      group:
        type: string
        default: ''
      store_artifacts:
        type: boolean
        default: false
    steps:
      - setup_dependencies
      - restore_websites_bundle
      - when:
          condition: <<parameters.build>>
          steps:
            - run:
                name: Building
                command: <<parameters.build>>
      - when:
          condition: <<parameters.start>>
          steps:
            - run:
                name: Starting
                command: <<parameters.start>>
                background: true
      - when:
          condition: <<parameters.wait-on>>
          steps:
            - run:
                name: Waiting on <<parameters.wait-on>>
                command: npx wait-on <<parameters.wait-on>>
      - run:
          name: Run Cypress tests
          command: |
            <<parameters.run-command>> \
              <<# parameters.spec>> --spec '<<parameters.spec>>' <</ parameters.spec>> \
              <<# parameters.record >> --record \
                <<# parameters.group>> --group '<<parameters.group>>' <</ parameters.group>> \
                <<# parameters.parallel>> --parallel <</ parameters.parallel>> \
              <</ parameters.record>>
      - when:
          condition: << parameters.store_artifacts >>
          steps:
            - store_artifacts:
                path: cypress/videos
            - store_artifacts:
                path: cypress/screenshots

workflows:
  version: 2
  build_and_test:
    jobs:
      - build_lint_and_test
      - vrt_test:
          requires:
            - build_lint_and_test
      - e2e_test:
          name: e2e_smoke_tests
          requires:
            - build_lint_and_test
          start: npx serve -l 8000 public
          wait-on: 'http://localhost:8000'
          run-command: PERCY_TOKEN="$PERCY_TOKEN_SMOKE_TESTS_E2E" yarn run percy exec -- yarn test:e2e
          store_artifacts: true
